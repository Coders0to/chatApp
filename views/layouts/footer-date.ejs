
<script>
/* ---------------------------
 Particles: hearts + sparkles
 - create both hearts and dots
 - random positions, sizes, durations
---------------------------- */
const currentRoute = "<%= currentRoute %>";
(function createParticles(){
 const parent = document.getElementById('particles');
 const total = 28; // mix hearts + sparkles
 for(let i=0;i<total;i++){
  const el = document.createElement('div');
  const isHeart = Math.random() > 0.5;
  el.className = 'particle ' + (isHeart ? 'heart' : 'spark');
  // random horizontal start
  const left = Math.random()*100;
  el.style.left = left + '%';
  // random bottom offset
  el.style.bottom = (Math.random()*8 - 2) + 'vh';
  // random duration and delay
  const dur = 10 + Math.random()*10; // 10-20s
  const delay = Math.random()*-10; // start offset to spread
  el.style.animationDuration = dur + 's';
  el.style.animationDelay = delay + 's';
  // scale & opacity
  const scale = 0.8 + Math.random()*0.6;
  el.style.transform = `translateY(0) scale(${scale})`;
  // content
  if(isHeart){
   el.innerHTML = '‚ù§Ô∏è';
   el.style.fontSize = (12 + Math.random()*18) + 'px';
  } else {
   // small sparkle dot
   el.style.width = (4 + Math.random()*6) + 'px';
   el.style.height = (4 + Math.random()*6) + 'px';
   el.style.borderRadius = '50%';
   el.style.background = `linear-gradient(180deg, ${lighten('--peach')}, ${lighten('--lilac')})`;
   el.classList.add('spark');
  }
  parent.appendChild(el);
 }
 // helper to map css var to color with lighten fallback
 function lighten(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName) || '#ffd7c2' }
})();

/* ---------------------------
 Card stack + swipe logic
---------------------------- */
const profiles = [
 {id:1,name:'',age:0,dist:'',bio:'',photo:'http://127.0.0.1:3000/images/no_image.webp'},
];


function loadMatchesTem() {
  fetch('/loadMatchesTem', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
  })
    .then(res => res.json())
    .then(data => {
      if (data && data.profiles && data.profiles.length > 0) {
          $('#controlTools').removeClass('d-none');
          profiles.length = 0;
          profiles.push(...data.profiles);
          renderStack();
      } else {
          $('#controlTools').addClass('d-none');
          $('#cardStack').html(`
                <div class="card-no-profile empty-card" role="article">
                  <div class="empty-state">
                      <div class="emoji">‚è≥</div>
                      <h3>Wait for new profile</h3>
                      <p>New profiles will appear here soon</p>
                      <div class="dots">
                          <span></span><span></span><span></span>
                      </div>
                  </div>
              </div>
          `);
      }
    })
    .catch(err => console.log("Error:", err));
}

if(currentRoute=='loadMatchesTem')
{
  loadMatchesTem();
  getRecentMatchesList();
}

const stackEl = document.getElementById('cardStack');
const tpl = document.getElementById('cardTpl');
const recentList = document.getElementById('recentList');
const chatPanel = document.getElementById('chatPanel');
const chatAvatar = document.getElementById('chatAvatar');
//const chatName = document.getElementById('chatName');
const chatBody = document.getElementById('chatBody');

let history = [];

function createCard(p){
  console.log('p record',p);
 const node = tpl.content.cloneNode(true).querySelector('.card');
 node.dataset.id = p.id;
 node.querySelector('.photo').style.backgroundImage = `url(${p.photo})`;
 node.querySelector('.photo .profile-img').src = p.photo;

 const photoEl = node.querySelector('.photo');
 const statusId = `${p.id}-status`;
 let statusEl = photoEl.querySelector('.userStatus');
 if (!statusEl) {
        statusEl = document.createElement('span');
        statusEl.className = 'userStatus';
        photoEl.appendChild(statusEl);
    }
  statusEl.id = statusId;
  statusEl.textContent = p.is_online == 1 ? 'Online' : 'Offline';
  statusEl.classList.toggle('online', p.is_online == 1);
  statusEl.classList.toggle('offline', p.is_online != 1);

 node.querySelector('.photo .userStatus').textContent = p.is_online == 1 ? 'Online' : 'Offline';
 node.querySelector('.cname').textContent = p.name;
 node.querySelector('.cage').textContent = p.age;
 node.querySelector('.cdistance').textContent = p.dist;
 node.querySelector('.userUId').value = p.id;
 node.querySelector('.bio').textContent = p.bio;
 attachDrag(node);
 return node;
}

function renderStack(){
 stackEl.innerHTML = '';
 const show = profiles.slice().reverse();
 show.forEach((p,i)=>{
  const card = createCard(p);
  card.style.zIndex = 100 - i;
  const scale = 1 - i*0.04;
  const y = i*12;
  card.style.transform = `translateY(${y}px) scale(${scale})`;
  card.style.opacity = 1 - i*0.05;
  stackEl.appendChild(card);
 });
}

/* drag / swipe */
function attachDrag(card){
 let startX=0,startY=0,offsetX=0,offsetY=0,dragging=false;
 const likeStamp = card.querySelector('.stamp.like');
 const nopeStamp = card.querySelector('.stamp.nope');

 function updateStamps(x){
  const threshold = 80;
  const opacity = Math.min(Math.abs(x)/threshold,1);
  if(x>0){ likeStamp.style.opacity = opacity; nopeStamp.style.opacity = 0; }
  else{ nopeStamp.style.opacity = opacity; likeStamp.style.opacity = 0; }
 }

 function onDown(e){
  dragging=true;
  startX = e.touches ? e.touches[0].clientX : e.clientX;
  startY = e.touches ? e.touches[0].clientY : e.clientY;
  card.style.transition = 'none';
 }
 function onMove(e){
  if(!dragging) return;
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - startX;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - startY;
  offsetX = x; offsetY = y;
  const rot = Math.min(Math.max(x/10,-25),25);
  card.style.transform = `translate(${x}px, ${y}px) rotate(${rot}deg)`;
  updateStamps(x);
 }
 function onUp(){
  if(!dragging) return; dragging=false; card.style.transition = '';
  const absX = Math.abs(offsetX); const threshold = 140;
  if(absX>threshold){
   const toRight = offsetX>0;
   card.style.transform = `translate(${toRight?1200:-1200}px, ${offsetY}px) rotate(${toRight?35:-35}deg)`;
   card.style.opacity = 0;
   setTimeout(()=> commitSwipe(card.dataset.id, toRight),260);
  } else {
   card.style.transform = '';
   likeStamp.style.opacity = 0; nopeStamp.style.opacity = 0;
  }
  offsetX=0; offsetY=0;
 }

 card.addEventListener('mousedown', onDown);
 window.addEventListener('mousemove', onMove);
 window.addEventListener('mouseup', onUp);
 card.addEventListener('touchstart', onDown, {passive:true});
 window.addEventListener('touchmove', onMove, {passive:true});
 window.addEventListener('touchend', onUp);

 // tap photo -> view profile
 card.querySelector('.photo').addEventListener('click', (ev)=> {
  ev.stopPropagation();
  openProfile(card.dataset.id);
 });
}

function commitSwipe(id, liked){
 const idx = profiles.findIndex(p=>String(p.id)===String(id));
 if(idx===-1) return;
 const [removed] = profiles.splice(idx,1);
 history.push({profile:removed,liked});
 addToRecent(removed,liked);
 renderStack();
}

function addToRecent(profile,liked){
  if(currentRoute=='loadMatchesTem'){
    getRecentMatchesList();
  }
}

/* Buttons */


if(currentRoute=='loadMatchesTem'){
  document.getElementById('likeBtn').addEventListener('click', ()=>{
  chatPanel.classList.remove('open'); chatPanel.setAttribute('aria-hidden','true');
 const top = stackEl.querySelector('.card'); if(!top) return;
 $.ajax({
        url: '/likeRecord',
        type: 'POST',
        data:{matches_id:top.dataset.id},
        success: function (res) {
          socket.emit('notifyLikedUser',{notify_user_id:res.data.matches_id,receiver_id:res.data.user_id});

        },
        error: function (err) {
        }
});
 top.style.transform = `translate(1200px,-120px) rotate(30deg)`; top.style.opacity = 0;
 setTimeout(()=> commitSwipe(top.dataset.id,true),220);
});
document.getElementById('nopeBtn').addEventListener('click', ()=>{
 const top = stackEl.querySelector('.card'); if(!top) return;
 top.style.transform = `translate(-1200px,-60px) rotate(-30deg)`; top.style.opacity = 0;
 setTimeout(()=> commitSwipe(top.dataset.id,false),220);
});
document.getElementById('superBtn').addEventListener('click', ()=>{
 const top = stackEl.querySelector('.card'); if(!top) return;
 top.style.transform = `translate(0px,-300px) scale(1.08)`; setTimeout(()=>{ top.style.transform = `translate(0px,-1200px)`; top.style.opacity = 0; setTimeout(()=> commitSwipe(top.dataset.id,true),240); },260);
});

document.getElementById('undoBtn').addEventListener('click', ()=>{
 const last = history.pop();
 if(!last) return alert('Kuch undo karne layak nahi hai');
 profiles.push(last.profile);
 renderStack();
 const first = recentList.querySelector('.recent-item'); if(first) first.remove();
});

document.getElementById('rewindBtn').addEventListener('click', ()=>{
    resetAllMatches();
 while(history.length){ profiles.push(history.pop().profile); }
 renderStack(); recentList.innerHTML = '';
});

/* View profile -> show in chatPanel as detail */
const viewBtn = document.getElementById('viewBtn');
viewBtn.addEventListener('click', ()=> {
 const top = profiles[0]; if(!top) return alert('Koi profile nahi');
 openProfile(top.id);
});

function openProfile(id){
 chatPanel.classList.add('open'); chatPanel.setAttribute('aria-hidden','false');
}

document.getElementById('closeChat').addEventListener('click', ()=> {
 chatPanel.classList.remove('open'); chatPanel.setAttribute('aria-hidden','true');
 $('#helpFab').show();
});

/* Help modal */
const helpFab = document.getElementById('helpFab'), helpModal = document.getElementById('helpModal'), closeHelp = document.getElementById('closeHelp');
helpFab.addEventListener('click', ()=> { helpModal.style.display = 'flex'; helpModal.setAttribute('aria-hidden','false'); });
closeHelp.addEventListener('click', ()=> { helpModal.style.display = 'none'; helpModal.setAttribute('aria-hidden','true'); });

}

/* keyboard shortcuts */
window.addEventListener('keydown', (e)=> {
 if(e.key === 'ArrowRight') document.getElementById('likeBtn').click();
 if(e.key === 'ArrowLeft') document.getElementById('nopeBtn').click();
 //if(e.key === ' ') { e.preventDefault(); document.getElementById('superBtn').click(); }
});

/* initial render */
//renderStack();


/* --- NEW: Sidebar Toggle Logic --- */
const menuToggle = document.querySelector('.menu-toggle');
const sidebar = document.querySelector('.sidebar');

menuToggle.addEventListener('click', (e) => {
    // Click ko page par ‡§´‡•à‡§≤‡§®‡•á (propagate) se roke
    e.stopPropagation(); 
    // Sidebar par 'sidebar-open' class lagaye/hataye
    sidebar.classList.toggle('sidebar-open');
});

// Bonus: Agar sidebar khula hai aur user main content par click kare, to use band kar de


if(currentRoute=='loadMatchesTem'){

}
// document.querySelector('.main-content').addEventListener('click', () => {
//     if (sidebar.classList.contains('sidebar-open')) {
//         //sidebar.classList.remove('sidebar-open');
//     }
// });

function getRecentMatchesList() {
  $.ajax({
    url: 'getRecentMatchesList',
    type: 'get',
    success: function(response) {
      if (response.success && response.data.length > 0) {
        const recentList = document.getElementById('recentList');
        recentList.innerHTML = "";
        response.data.forEach(profile => {
          const item = document.createElement('div');
          item.className = 'recent-item';
          item.innerHTML = `
            <img src="${profile.image}" alt="${profile.name}">
            <div class='rmeta'>
              <strong>${profile.name}</strong>
              <div style="color:var(--muted);font-size:13px">
                ${profile.location ? profile.location : ''} ${profile.is_online == "1" ? "‚Ä¢ Online üü¢" : "‚Ä¢ Offline üî¥"}
              </div>
            </div>
          `;
          recentList.prepend(item);
        });
      } else {
      }
    },
    error: function(error) {
      console.error("Error:", error);
    }
  });
}



function resetAllMatches(){
    $.ajax({
    url: 'resetAllMatches',
    type: 'get',
    success: function(response) {
      if (response.success && response.statusCode == 200) {
            loadMatchesTem();
            getRecentMatchesList();
      } else {
      }
    },
    error: function(error) {
      console.error("Error:", error);
    }
  });
}
function getNotification()
    {
        $.ajax({
            url:'getCountNotification',
            type:'get',
            success:function(response){
                if(response.statusCode==200){
                    $('#countNotify').text(response.notificationCount);
                }
            },
            error:function(error){

            }
        });
    }
    getNotification();

</script>
</body>
</html>

